pipeline {
  agent { 
    docker { 
      image 'python:3.8.5' 
    }  
  }
  environment {
        FLASK_APP = 'run.py'
    }
  stages {
    stage('build') {
      agent {
        docker {
          image 'postgres'
          args  '--name postgres -e POSTGRES_DB=redactorzone_test -e POSTGRES_USER=postgres -e POSTGRES_PASSWORD=root -p 5432:5432 -d postgres'
        } 
      }
      steps {
        sh 'pip install -r requirements.txt'
        sh  'python -m flask db upgrade'
      }
    }
    stage('test') {
      steps {
        sh 'python -m unittest discover'
      }   
    }
  }
}